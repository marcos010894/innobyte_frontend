import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import FiltersSection from '@components/users/FiltersSection';
import LicensesTable from '@components/users/LicensesTable';
import { getUsuarios, type UsuariosFilters } from '../services';

const UsersManagement = () => {
  const navigate = useNavigate();
  const [showFilters, setShowFilters] = useState(true);
  const [usuarios, setUsuarios] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [summary, setSummary] = useState({
    vencidas_hoje: 0,
    vencendo_3_dias: 0,
    vencendo_7_dias: 0,
    bloqueadas: 0,
    ativas: 0,
    total_licencas: 0,
  });
  const [filters, setFilters] = useState<UsuariosFilters>({
    page: 1,
    limit: 10,
  });

  // Carrega usuários da API
  useEffect(() => {
    loadUsuarios();
  }, [filters]);

  const loadUsuarios = async () => {
    setLoading(true);
    const result = await getUsuarios(filters);
    
    if (result.success && result.data) {
      setUsuarios(result.data.data);
      setSummary(result.data.summary || summary);
    } else {
      console.error('Erro ao carregar usuários:', result.message);
    }
    
    setLoading(false);
  };

  const handleApplyFilters = (filterData: any) => {
    setFilters({
      ...filters,
      cliente: filterData.cliente || undefined,
      email: filterData.email || undefined,
      tipo_licenca: filterData.tipoLicenca || undefined,
      bloqueada: filterData.statusBloqueio === 'bloqueada' ? true : 
                 filterData.statusBloqueio === 'ativa' ? false : undefined,
      page: 1, // Reset para primeira página
    });
    setShowFilters(false);
  };

  const handleClearFilters = () => {
    setFilters({ page: 1, limit: 10 });
  };

  const handleNewLicense = () => {
    navigate('/users/new');
  };

  const handleEditLicense = (license: any) => {
    navigate(`/users/edit/${license.id}`);
  };

  return (
    <div>
      {/* Page Header */}
      <div className="mb-6 flex justify-between items-start">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">Gerenciamento de Usuários e Licenças</h1>
          <p className="text-gray-600">Gerencie licenças, clientes e permissões do sistema</p>
        </div>
        <div className="flex gap-3">
          <button
            onClick={() => setShowFilters(true)}
            className="px-6 py-3 bg-primary text-white rounded-md hover:bg-blue-600 transition-colors flex items-center gap-2 shadow-md"
          >
            <i className="fas fa-filter"></i>
            Filtros
          </button>
          <button
            onClick={handleNewLicense}
            className="px-6 py-3 bg-success text-white rounded-md hover:bg-green-600 transition-colors flex items-center gap-2 shadow-md"
          >
            <i className="fas fa-plus"></i>
            Novo Usuário
          </button>
        </div>
      </div>

      {/* Alerts Section */}
      <div className="mb-6 flex items-center gap-4">
        <div className="bg-red-50 border border-red-200 rounded-lg p-4 flex items-start gap-3 flex-1">
          <i className="fas fa-bell text-red-500 text-xl mt-0.5"></i>
          <div>
            <h3 className="font-semibold text-red-800 mb-1">Atenção: Licenças Vencidas</h3>
            <div className="text-sm text-red-700">
              <span className="font-medium">{summary.vencidas_hoje}</span> licenças vencidas hoje •{' '}
              <span className="font-medium">{summary.vencendo_3_dias}</span> vencem em 3 dias •{' '}
              <span className="font-medium">{summary.vencendo_7_dias}</span> vencem em 7 dias
            </div>
          </div>
        </div>

        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 flex items-start gap-3 flex-1">
          <i className="fas fa-lock text-yellow-600 text-xl mt-0.5"></i>
          <div>
            <h3 className="font-semibold text-yellow-800 mb-1">Licenças Bloqueadas</h3>
            <div className="text-sm text-yellow-700">
              <span className="font-medium">{summary.bloqueadas}</span> licenças bloqueadas no momento
            </div>
          </div>
        </div>

        <div className="bg-green-50 border border-green-200 rounded-lg p-4 flex items-start gap-3 flex-1">
          <i className="fas fa-check-circle text-green-600 text-xl mt-0.5"></i>
          <div>
            <h3 className="font-semibold text-green-800 mb-1">Licenças Ativas</h3>
            <div className="text-sm text-green-700">
              <span className="font-medium">{summary.ativas}</span> de {summary.total_licencas} licenças ativas
            </div>
          </div>
        </div>
      </div>

      {/* Licenses Table */}
      <LicensesTable 
        onEdit={handleEditLicense} 
        usuarios={usuarios}
        loading={loading}
        onRefresh={loadUsuarios}
      />
        <div className="bg-red-50 border border-red-200 rounded-lg p-4 flex items-start gap-3 flex-1">
          <i className="fas fa-bell text-red-500 text-xl mt-0.5"></i>
          <div>
            <h3 className="font-semibold text-red-800 mb-1">Atenção: Licenças Vencidas</h3>
            <div className="text-sm text-red-700">
              <p className="mb-1"><strong>Vencidas hoje:</strong> 4 licenças</p>
              <p><strong>Vencendo em 3 dias:</strong> 1 licença</p>
            </div>
          </div>
        </div>
      </div>

      {/* Licenses Table */}
      <LicensesTable onSelectLicense={handleEditLicense} />

      {/* Filters Sidebar */}
      {showFilters && (
        <>
          {/* Backdrop with blur */}
          <div 
            className="fixed inset-0 bg-black/30 backdrop-blur-sm z-40 animate-fadeIn"
            onClick={() => setShowFilters(false)}
          ></div>
          
          {/* Sidebar */}
          <div className="fixed top-0 right-0 h-full w-full sm:w-[500px] bg-white shadow-2xl z-50 overflow-y-auto animate-slideInRight">
            <div className="p-6">
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                  <i className="fas fa-filter text-primary"></i>
                  Filtros Avançados
                </h2>
                <button
                  onClick={() => setShowFilters(false)}
                  className="text-gray-500 hover:text-gray-700 transition-colors p-2 hover:bg-gray-100 rounded-full"
                >
                  <i className="fas fa-times text-xl"></i>
                </button>
              </div>
              
              <FiltersSection onClose={() => setShowFilters(false)} />
            </div>
          </div>
        </>
      )}
    </div>
  );
};

export default UsersManagement;
